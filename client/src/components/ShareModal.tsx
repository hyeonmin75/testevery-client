import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { CalculatedResult } from '../types/test';

interface ShareModalProps {
  isOpen: boolean;
  onClose: () => void;
  result: CalculatedResult;
}

export function ShareModal({ isOpen, onClose, result }: ShareModalProps) {
  const [notification, setNotification] = useState<string>('');

  const showNotification = (message: string) => {
    setNotification(message);
    setTimeout(() => setNotification(''), 3000);
  };

  const shareToKakao = async () => {
    const text = `ë‚˜ëŠ” ${result.result.title}ì…ë‹ˆë‹¤! ${result.result.description}`;
    const url = window.location.href;
    const fullText = `${text}\n${url}`;
    
    try {
      await navigator.clipboard.writeText(fullText);
      showNotification('í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¹´ì¹´ì˜¤í†¡ì—ì„œ ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.');
    } catch (err) {
      prompt('ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”:', fullText);
    }
  };

  const shareToFacebook = () => {
    const url = encodeURIComponent(window.location.href);
    const text = encodeURIComponent(`ë‚˜ëŠ” ${result.result.title}ì…ë‹ˆë‹¤!`);
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
  };

  const shareToTwitter = () => {
    const text = encodeURIComponent(`ë‚˜ëŠ” ${result.result.title}ì…ë‹ˆë‹¤! ${result.result.description}`);
    const url = encodeURIComponent(window.location.href);
    window.open(`https://twitter.com/intent/tweet?text=${text}&url=${url}`, '_blank');
  };

  const shareToInstagram = async () => {
    const text = `ë‚˜ëŠ” ${result.result.title}ì…ë‹ˆë‹¤! ${result.result.description}`;
    try {
      await navigator.clipboard.writeText(text);
      showNotification('í…ìŠ¤íŠ¸ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤! ì¸ìŠ¤íƒ€ê·¸ë¨ì—ì„œ ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.');
    } catch (err) {
      prompt('ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”:', text);
    }
  };

  const copyLink = async () => {
    const text = `ë‚˜ëŠ” ${result.result.title}ì…ë‹ˆë‹¤! ${result.result.description}`;
    const url = window.location.href;
    const fullText = `${text}\n${url}`;
    
    try {
      await navigator.clipboard.writeText(fullText);
      showNotification('ê²°ê³¼ í…ìŠ¤íŠ¸ì™€ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
    } catch (err) {
      prompt('ë‹¤ìŒ í…ìŠ¤íŠ¸ë¥¼ ë³µì‚¬í•´ì£¼ì„¸ìš”:', fullText);
    }
  };

  const downloadImage = () => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    if (!ctx) return;

    canvas.width = 1080;
    canvas.height = 1920;

    // ë°°ê²½ ì„¤ì •
    if (result.testId === 'intuition_test') {
      // ëˆˆì¹˜ë ¥ í…ŒìŠ¤íŠ¸ ë°°ê²½
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#f0fdf4');
      gradient.addColorStop(0.5, '#eff6ff');
      gradient.addColorStop(1, '#faf5ff');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    } else {
      // ì¼ë°˜ í…ŒìŠ¤íŠ¸ ë°°ê²½
      const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
      gradient.addColorStop(0, '#667eea');
      gradient.addColorStop(1, '#764ba2');
      ctx.fillStyle = gradient;
      ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // í…ìŠ¤íŠ¸ ì„¤ì •
    ctx.fillStyle = result.testId === 'intuition_test' ? '#1f2937' : 'white';
    ctx.textAlign = 'center';
    let y = 200;

    // ì´ëª¨ì§€
    ctx.font = '80px Arial';
    ctx.fillText(result.result.emoji, canvas.width / 2, y);
    y += 120;

    // ì œëª©
    ctx.font = 'bold 42px "Malgun Gothic", Arial, sans-serif';
    ctx.fillText(`ë‹¹ì‹ ì€ ${result.result.title}ì…ë‹ˆë‹¤!`, canvas.width / 2, y);
    y += 80;

    // ì„¤ëª…
    ctx.font = '30px "Malgun Gothic", Arial, sans-serif';
    ctx.fillText(result.result.description, canvas.width / 2, y);

    // ë‹¤ìš´ë¡œë“œ
    const link = document.createElement('a');
    link.download = `${result.result.title}_ê²°ê³¼.png`;
    link.href = canvas.toDataURL();
    link.click();
    
    showNotification('ì´ë¯¸ì§€ê°€ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
  };

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onClick={onClose}>
      <div className="bg-white rounded-3xl p-8 max-w-md w-full" onClick={(e) => e.stopPropagation()}>
        <div className="text-center mb-6">
          <div className="text-4xl mb-4">{result.result.emoji}</div>
          <h3 className="text-xl font-bold text-gray-800 mb-2">ê²°ê³¼ ê³µìœ í•˜ê¸°</h3>
          <p className="text-gray-600">ì¹œêµ¬ë“¤ê³¼ í•¨ê»˜ ì¬ë¯¸ìˆëŠ” í…ŒìŠ¤íŠ¸ë¥¼ ì¦ê²¨ë³´ì„¸ìš”!</p>
        </div>
        
        <div className="grid grid-cols-2 gap-4 mb-6">
          <button
            onClick={shareToKakao}
            className="flex items-center gap-3 p-4 bg-yellow-50 hover:bg-yellow-100 rounded-2xl transition-colors"
          >
            <div className="w-10 h-10 bg-yellow-400 rounded-full flex items-center justify-center">
              <span className="text-white">ğŸ’¬</span>
            </div>
            <span className="font-semibold text-gray-800">ì¹´ì¹´ì˜¤í†¡</span>
          </button>
          
          <button
            onClick={shareToFacebook}
            className="flex items-center gap-3 p-4 bg-blue-50 hover:bg-blue-100 rounded-2xl transition-colors"
          >
            <div className="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
              <span className="text-white">ğŸ“˜</span>
            </div>
            <span className="font-semibold text-gray-800">í˜ì´ìŠ¤ë¶</span>
          </button>
          
          <button
            onClick={shareToTwitter}
            className="flex items-center gap-3 p-4 bg-gray-50 hover:bg-gray-100 rounded-2xl transition-colors"
          >
            <div className="w-10 h-10 bg-gray-800 rounded-full flex items-center justify-center">
              <span className="text-white">ğŸ¦</span>
            </div>
            <span className="font-semibold text-gray-800">íŠ¸ìœ„í„°</span>
          </button>
          
          <button
            onClick={shareToInstagram}
            className="flex items-center gap-3 p-4 bg-pink-50 hover:bg-pink-100 rounded-2xl transition-colors"
          >
            <div className="w-10 h-10 bg-pink-500 rounded-full flex items-center justify-center">
              <span className="text-white">ğŸ“·</span>
            </div>
            <span className="font-semibold text-gray-800">ì¸ìŠ¤íƒ€ê·¸ë¨</span>
          </button>
        </div>
        
        <button
          onClick={copyLink}
          className="w-full bg-green-50 hover:bg-green-100 text-green-800 py-3 rounded-2xl font-semibold transition-all mb-4"
        >
          <span className="mr-2">ğŸ”—</span>í…ìŠ¤íŠ¸ì™€ ë§í¬ ë³µì‚¬í•˜ê¸°
        </button>
        
        <button
          onClick={downloadImage}
          className="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-3 rounded-2xl font-semibold hover:from-purple-600 hover:to-pink-600 transition-all mb-4"
        >
          <span className="mr-2">ğŸ“·</span>ê²°ê³¼ ì´ë¯¸ì§€ ìƒì„±
        </button>
        
        <button
          onClick={onClose}
          className="w-full bg-gray-100 text-gray-700 py-3 rounded-2xl font-semibold hover:bg-gray-200 transition-colors"
        >
          ë‹«ê¸°
        </button>

        {notification && (
          <div className="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
            {notification}
          </div>
        )}
      </div>
    </div>
  );
}